<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>用户管理</title>
<link rel="stylesheet" type="text/css" href="/css/webcss/jquery.dataTables.min.css">
<script type="text/javascript" language="javascript" src="/js/webjs/jquery-1.11.3.js">
	</script>
<link rel="stylesheet" type="text/css" href="/css/webcss/example.css">
<script type="text/javascript" language="javascript" src="/js/webjs/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/webcss/global.css"/>
<link rel="stylesheet" type="text/css" href="/css/webcss/jquery-ui.css" />
<link rel="stylesheet" href="/css/webcss/jquery-ui.theme.css"/>
<script src="/js/webjs/jquery-ui.js"></script>
<script src="/js/webjs/select2.full.js"></script>
<link href="/css/webcss/select2.css" rel="stylesheet">
</head>

<body>
<div class="nav">
  <div class="container"> <img src="images/logo-white1.png">
    <ul class="nav-header">
      <li><a href="">发票识别</a></li>
      <li><a  href="">发票审核</a></li>
      <li><a href="">发票管理</a></li>
      <li><a   class="fp"  href="">用户管理</a></li>
    </ul>
  </div>
</div>
<div class="nav-t">
  <div class="container">
    <ul class="nav-l">

      <li><a class="bj2" id="add-user-btn">添加用户</a></li>
      <li><a class="bj2" id="edit-user-btn">编辑用户</a></li>
      <li><a class="bj2" id="delete-user-btn">删除用户</a></li>
    </ul>
    <ul class="table-l">
      <table id="example" class="display" cellspacing="0" width="100%">

        
      </table>
    </ul>
  </div>
</div>


<div id="add-user-dialog">
  <ul class="tj-l">
    <li><span>用户名</span>
      <input id="name" type="text"  value="">
    </li>
    <li><span>公司名称</span>
      <input id="company" type="text" value="">
    </li>
    <li><span>用户类型</span>
      <select id="add-role" tabindex="" name="htmltest" multiple="multiple">
      </select>
    </li>
  </ul>
</div>
<div id="edit-user-dialog">
  <ul class="tj-l">
    <li><span>用户名</span>
      <input id="edit-name" type="text"  value="">
    </li>
    <li><span>公司名称</span>
      <input id="edit-company" type="text" value="">
    </li>
    <li><span>用户类型</span>
      <select id="edit-role" tabindex="" name="htmltest" multiple="multiple">
      </select>
    </li>
  </ul>
</div>

<div class="footer">
  <div class="container">
    <p>沪ICP备15012848号 | COPYRIGHT © 2014-2015, BANGBANGZHANG, ALL RIGHTS RESERVED </p>
  </div>
</div>
</body>
<script>
function deleteRow(elem) {
    var tableObj = document.getElementById("example");
	var tr=elem.parentNode.parentNode;	
	tr.parentNode.removeChild(tr);
    
  }
</script>
<script>

	
	$(document).ready(function() {
		var dataSet = [];
		var roles = [];
		$.post('/user/getAllUsersWithWorkRecords', {},function(data){
			 dataSet  = $.parseJSON(data.data);
			    var table = $('#example').DataTable({"sDom": '<"top" f>rt<"bottom" p><"clear">',
			    	data: dataSet,	
			    	columns: [
			    	          	{title: "员工号"},
			    	            { title: "姓名" },
			    	            { title: "公司" },
			    	            { title: "识别数" },
			    	            { title: "审核数." },

			    	        ]
			    });

			    $('#example tbody').on( 'click', 'tr', function () {
			        if ( $(this).hasClass('selected') ) {
			            $(this).removeClass('selected');
			        }
			        else {
			            table.$('tr.selected').removeClass('selected');
			            $(this).addClass('selected');
			        }
			    } );
			    
			    
			    $("#edit-user-btn").on("click", function(){
			    	console.log(table.row('.selected').data());
			    	var id = table.row('.selected').data()[0];
			    	var name = table.row('.selected').data()[1];
			    	var company = table.row('.selected').data()[2];
			    	$("#edit-name").val(name);
			    	$("#edit-company").val(company);

					  $.post("/user/getUserRoles", {"id":id}, function(data){
						  var options = $.parseJSON(data.data);
					    	$(".sol-container").each(function(){
					    		$(this).remove();
					    	});
					    	//$("#edit-role").empty();
					    	$("#edit-role").val('').trigger('chosen:updated');
					    	$('#edit-role').css("display","inline-block");	
					    	$("#edit-role").attr("name", "htmltest");
					    	console.log($("#edit-role"));
					    	$.each(roles, function(key, value){

					    		if($.inArray(value, options) !== -1){

					    		     $('#edit-role')
				    	        	  .append($('<option selected="selected">', { key: value })
				    	          	  .text(value)); 
					    		}else{
				    			
					    		     $('#edit-role')
				    	        	  .append($('<option>', { key: value })
				    	          	  .text(value)); 
					    		}
					    		
					    	});
				    		$('#edit-role').searchableOptionList({
				    			texts : {
				    				searchplaceholder: '点击此处查询用户角色',
				    				  selectAll: '全选',
				    				  selectNone: '取消全选',

				    				}
				    		});
				    		$("#edit-role").trigger("chosen:updated");
				    	});
			    	console.log("hello");
			    	$("#edit-user-dialog").dialog({
			    		height:480,
			    		  width:640,
			    		  title:"编辑用户",
			    		  buttons: [
			    		            {
			    		              text: "编辑用户",
			    		              icons: {
			    		                primary: "ui-icon-heart"
			    		              },
			    		              click: function() {
			    		    		    	var name = $("#edit-name");
			    		    		    	var company = $("#edit-company");
			    		    		    	var role = $('#add-role').find(":selected").text();
			    		    		    	
			    		    		    	$.post('/user/addUser',{'name':name.val(), 'company':company.val(),'role':role},function(data){
			    		    		    		console.log(data);
			    		    		    	});
			    		    		    	console.log(role);
			    		                $( this ).dialog( "close" );
			    		              }
			    		         
			    		              // Uncommenting the following line would hide the text,
			    		              // resulting in the label being used as a tooltip
			    		              //showText: false
			    		            },{
			    		            	text: "取消",
				    		              icons: {
				    		                primary: "ui-icon-heart"
				    		              },
				    		              click: function() {
				    		                $( this ).dialog( "close" );
				    		              }
			    		            }
			    		          ]
			    		        });
			    		
			    	});
			    
		});

    	var optionData = [];

		    $.post("/role/getAllRoles",{},function(data){
		    	console.log(data);

		    	var options = $.parseJSON(data.data);

		    	$.each(options[0], function( key, value) { 
		    		console.log(key);
		    		console.log(value);
		    		roles.push(value);
		    		optionData.push({"id":key, "text":value});
		    	  //   $('#add-role')
		    	    //      .append($('<option>', { key: value })
		    	      //    .text(value)); 



		    	});
		    	console.log(optionData);

	    		/*$('#add-role').searchableOptionList({
	    			texts : {
	    				searchplaceholder: '点击此处查询用户角色',
	    				  selectAll: '全选',
	    				  selectNone: '取消全选',

	    				}
	    		});*/
		    });



		    
		    
		    $("#add-user-btn").on("click", function(){
		    	$("#add-role").select2({data:optionData});
		    	$("#add-user-dialog").dialog({
		    		  height:480,
		    		  width:640,
		    		  title:"添加用户",
		    		  buttons: [
		    		            {
		    		              text: "添加用户",
		    		              icons: {
		    		                primary: "ui-icon-heart"
		    		              },
		    		              click: function() {
		    		    		    	var name = $("#name");
		    		    		    	var company = $("#company");
		    		    		    	var role = $('#add-role').find(":selected").text();
		    		    		    	console.log(role);
		    		    		    	
		    		    		    	$.post('/user/addUser',{'name':name.val(), 'company':company.val(),'role':role},function(data){
		    		    		    		console.log(data);
		    		    		    	});
		    		    		    	console.log(role);
		    		                $( this ).dialog( "close" );
		    		              }
		    		         
		    		              // Uncommenting the following line would hide the text,
		    		              // resulting in the label being used as a tooltip
		    		              //showText: false
		    		            },{
		    		            	text: "取消",
			    		              icons: {
			    		                primary: "ui-icon-heart"
			    		              },
			    		              click: function() {
			    		                $( this ).dialog( "close" );
			    		              }
		    		            }
		    		          ]
		    		        });
		    	
		    });
		    
	//	});//get all post ends


	    $('#example tbody tr').on('click', 'td', function () {
	        var data = table.row( this ).data();
	        alert( 'You clicked on '+data[0]+'\'s row' );
	    } );


 
    $('#button').click( function () {
        table.row('.selected').remove().draw( false );
    } );
} );
	</script>

</html>
